<!doctype html>
<meta charset="utf-8">
<link rel="stylesheet" href="/assets/css/style.css">
<style>
	:root {
		--ds-primary: var(--ds-simplystore);
		--ds-primary-contrast: var(--ds-simplystore-contrast);
		--ds-primary-gradient: var(--ds-simplystore-gradient);
		--ds-primary-gradient-bump: var(--ds-simplystore-gradient-bump);
	}
	#databrowser {
		border:  0;
		margin:  0;
		padding: 0;
		width: 50%;
		height: 80vh;
	}
	form.Query {
		width: 49%;
		float: left;
		height: calc(100vh - 65px);		
		margin-right: 1%;
		margin-top: 65px;
	}
	.CodeMirror {
		height: 100% !important;
	}
	.dataBrowser {
		height: calc(100vh - 65px);
		margin-top: 65px;
	}
	body {
		position: fixed;
		width: 100%;
	}
</style>
<body class="ds-nightmode">
<header>
    <nav class="ds-toolbar">
        <div class="simply-title">
            <img src="/assets/img/simplystore-narrow.svg" alt="SimplyStore">
        </div>
        <button data-simply-command="run-query" class="ds-button ds-button-icon">
            <svg class="ds-icon ds-icon-feather">
                <use xlink:href="/assets/feather-sprite.svg#search">
            </use></svg>
            Run Query
        </button>
        <span class="ds-push-right"></span>
        <button class="ds-button ds-button-icon">
            <svg class="ds-icon ds-icon-feather">
                <use xlink:href="/assets/feather-sprite.svg#help-circle">
            </use></svg>
            Help
        </button>
    </nav>
</header>

<form data-simply-command="query" class="Query" data-simply-keyboard="query">
<textarea name="query" id="codeEditor" class="CodeMirror"></textarea>
</form>

<div class="dataBrowser">
	<textarea id="databrowser" class="CodeMirror" data-simply-field="data"></textarea>
</div>

<script src="/codemirror/lib/codemirror.js"></script>
<link rel="stylesheet" href="/codemirror/lib/codemirror.css">
<script src="/codemirror/mode/javascript/javascript.js"></script>
<link rel="stylesheet" href="/codemirror/theme/material-ocean.css">
<script src="https://unpkg.com/@muze-nl/jsontag@0.8.3/dist/browser.js"></script>
<script src="https://cdn.simplyedit.io/1/simply-edit.js"></script>
<script src="https://unpkg.com/simplyview@2.0.3/dist/simply.everything.js"></script>
<script>
	var codeEditor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
		lineNumbers: true,
		styleActiveLine: true,
		matchBrackets: true,
		theme: 'material-ocean'
	})
	codeEditor.focus()
	var browser = CodeMirror.fromTextArea(document.getElementById('databrowser'), {
		theme: 'material-ocean',
		readOnly: true
	})
</script>
<script>
	const databrowser = simply.app({
		routes: {
			'/:*': async (params) => {
				await databrowser.actions.query(window.location.pathname)
				browser.setValue(databrowser.view.data)
			}
		},
		commands: {
			'run-query': async function(button, value) {
				await this.app.actions.query(window.location.pathname, codeEditor.getValue())
				browser.setValue(databrowser.view.data)
			},
			query: async function(form, values) {
				await this.app.actions.query(window.location.pathname, values.query)
				browser.setValue(databrowser.view.data)
			}
		},
		actions: {
			query: async function(path, query) {		
				try {
					let data;
					if (query) {
						data = await api.post(path, query)
					} else {
						data = await api.get(path)
					}
					databrowser.view.data = JSONTag.stringify(data, null, 4)
					return data
				} catch(err) {
					databrowser.view.data = JSONTag.stringify(err, null, 4)
					return err
				}
			}
		},
		keyboard: {
			query: {
				'Control+Enter': async function() {
					await databrowser.actions.query(window.location.pathname, codeEditor.getValue())
					browser.setValue(databrowser.view.data)
				}
			}
		}
	})

	const apiBase = window.location.protocol+'//'+window.location.host;
	const api = {
		get: function(path, params) {
			let url = apiBase+path;
			if (!params && window.location.search) {
				url += window.location.search
			}
			if (params) {
				var args = Object.keys(params).map(param => encodeURIComponent(param)+'='+encodeURIComponent(params[param])).join('&')
				url += '?' + args
			}
			return fetch(url, {
				headers: {
					'Accept': 'application/jsontag'
				}
			})
			.then(response => {
				let jsontag = response.text().then(JSONTag.parse)
				if (response.ok) {
					return jsontag
				}
				return jsontag.then(Promise.reject.bind(Promise))
			})
		},
		post: function(path, query, params) {
			let url = apiBase+path;
			if (!params && window.location.search) {
				url += window.location.search
			}
			if (params) {
				var args = Object.keys(params).map(param => encodeURIComponent(param)+'='+encodeURIComponent(params[param])).join('&')
				url += '?' + args
			}
			
			return fetch(url, {
				method: 'POST',
				headers: {
					'Accept': 'application/jsontag'
				},
				body: query
			})
			.then(response => {
				let jsontag = response.text().then(JSONTag.parse)
				if (response.ok) {
					return jsontag
				}
				return jsontag.then(Promise.reject.bind(Promise))
			})	
		}
	}
</script>